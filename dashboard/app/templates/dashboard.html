{% extends "base.html" %}

{% block content %}

{% if error %}
<div style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:12px;padding:16px 20px;margin-bottom:24px;font-size:13px;color:#f87171;">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% if metrics %}

<!-- ═══════════════════════════════════════
     KPI ROW
═══════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px;">

    <!-- Leads Today -->
    <div class="d-card lift" style="padding:24px 24px 20px;"
         x-data="{ val: 0 }" x-init="
           let target = {{ metrics.summary.leads_today }};
           let step = Math.max(1, Math.ceil(target/40));
           let t = setInterval(() => { val = Math.min(val+step, target); if(val>=target) clearInterval(t); }, 30);
         ">
        <div class="kpi-label" style="margin-bottom:12px;">Added Today</div>
        <div class="kpi-num" x-text="val.toLocaleString()">0</div>
        <div style="margin-top:10px;display:flex;align-items:center;gap:6px;">
            <span class="trend-up">↑ Fresh leads</span>
        </div>
        <div id="spark-today" style="margin-top:12px;height:36px;"></div>
    </div>

    <!-- Total in CRM -->
    <div class="d-card lift" style="padding:24px 24px 20px;"
         x-data="{ val: 0 }" x-init="
           let target = {{ metrics.summary.total_leads }};
           let step = Math.max(1, Math.ceil(target/40));
           let t = setInterval(() => { val = Math.min(val+step, target); if(val>=target) clearInterval(t); }, 20);
         ">
        <div class="kpi-label" style="margin-bottom:12px;">Total Contacts</div>
        <div class="kpi-num" x-text="val.toLocaleString()">0</div>
        <div style="margin-top:10px;">
            <span style="font-size:11px;color:var(--tx3);">{{ metrics.summary.contacted }} contacted</span>
        </div>
        <div id="spark-total" style="margin-top:12px;height:36px;"></div>
    </div>

    <!-- Total Replies -->
    <div class="d-card lift" style="padding:24px 24px 20px;"
         x-data="{ val: 0 }" x-init="
           let target = {{ metrics.summary.total_responses }};
           let step = Math.max(1, Math.ceil(target/40));
           let t = setInterval(() => { val = Math.min(val+step, target); if(val>=target) clearInterval(t); }, 40);
         ">
        <div class="kpi-label" style="margin-bottom:12px;">Replies Received</div>
        <div class="kpi-num" style="color:#22c55e;" x-text="val.toLocaleString()">0</div>
        <div style="margin-top:10px;">
            <span class="badge badge-green">Active signal</span>
        </div>
        <div id="spark-replies" style="margin-top:12px;height:36px;"></div>
    </div>

    <!-- Reply Rate -->
    <div class="d-card lift" style="padding:24px 24px 20px;"
         x-data="{ val: 0.0 }" x-init="
           let target = {{ metrics.summary.response_rate }};
           let steps = 40;
           let inc = target/steps;
           let t = setInterval(() => { val = Math.min(parseFloat((val+inc).toFixed(1)), target); if(val>=target) clearInterval(t); }, 30);
         ">
        <div class="kpi-label" style="margin-bottom:12px;">Reply Rate</div>
        <div class="kpi-num" style="color:var(--accent);" x-text="val.toFixed(1)+'%'">0%</div>
        <div style="margin-top:10px;">
            <div class="prog-track" style="height:4px;">
                <div class="prog-fill" style="background:var(--accent);width:{{ [metrics.summary.response_rate * 5, 100] | min }}%;"></div>
            </div>
        </div>
        <div id="spark-rate" style="margin-top:12px;height:36px;"></div>
    </div>

</div>

<!-- ═══════════════════════════════════════
     PIPELINE FUNNEL
═══════════════════════════════════════ -->
<div class="d-card" style="padding:28px;margin-bottom:20px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
        <div>
            <div class="section-label">Pipeline</div>
            <div style="font-size:16px;font-weight:700;color:var(--tx1);margin-top:4px;">Lead Flow</div>
        </div>
        <div style="font-size:11px;color:var(--tx3);">Total: {{ metrics.summary.total_leads }} contacts</div>
    </div>

    {% set total = metrics.summary.total_leads if metrics.summary.total_leads > 0 else 1 %}
    {% set stages = [
        ('New',        metrics.pipeline.new,       '#6b7099', 'Scraped & queued'),
        ('Contacted',  metrics.pipeline.contacted,  '#3b82f6', 'Email sent'),
        ('Replied',    metrics.pipeline.replied,    '#c8a15a', 'Responded'),
        ('Won',        metrics.pipeline.won,        '#22c55e', 'Converted'),
    ] %}

    <div style="display:flex;gap:8px;align-items:stretch;">
    {% for name, count, color, desc in stages %}
        {% set pct = [(count / total * 100), 100] | min %}
        <div style="flex:1;display:flex;flex-direction:column;gap:10px;">
            <div style="font-size:11px;font-weight:600;color:{{ color }};text-transform:uppercase;letter-spacing:.08em;">{{ name }}</div>
            <div style="font-size:28px;font-weight:800;color:var(--tx1);letter-spacing:-.03em;font-variant-numeric:tabular-nums;">{{ count }}</div>
            <div style="font-size:11px;color:var(--tx3);">{{ desc }}</div>
            <!-- Bar -->
            <div class="prog-track" style="height:6px;margin-top:4px;">
                <div class="prog-fill" style="background:{{ color }};width:{{ pct }}%;"></div>
            </div>
            <div style="font-size:10px;color:var(--tx3);">{{ '%.0f'|format(pct) }}% of total</div>
        </div>
        {% if not loop.last %}
        <div style="display:flex;align-items:center;padding-top:24px;color:var(--tx3);font-size:18px;">→</div>
        {% endif %}
    {% endfor %}
    </div>
</div>

<!-- ═══════════════════════════════════════
     CHARTS ROW — Activity + Reply Intel
═══════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:3fr 2fr;gap:16px;margin-bottom:20px;">

    <!-- Weekly Activity Chart -->
    <div class="d-card" style="padding:28px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
            <div>
                <div class="section-label">Activity</div>
                <div style="font-size:16px;font-weight:700;color:var(--tx1);margin-top:4px;">14-Day Trend</div>
            </div>
            <div style="display:flex;gap:16px;font-size:11px;">
                <span style="display:flex;align-items:center;gap:5px;color:var(--tx3);">
                    <span style="width:10px;height:2px;background:#4a9e8a;display:inline-block;border-radius:1px;"></span> Outreach
                </span>
                <span style="display:flex;align-items:center;gap:5px;color:var(--tx3);">
                    <span style="width:10px;height:2px;background:#c8a15a;display:inline-block;border-radius:1px;"></span> Replies
                </span>
            </div>
        </div>
        <div id="chart-activity" style="min-height:220px;"></div>
    </div>

    <!-- Reply Intelligence -->
    <div class="d-card" style="padding:28px;">
        <div style="margin-bottom:20px;">
            <div class="section-label">Reply Intelligence</div>
            <div style="font-size:16px;font-weight:700;color:var(--tx1);margin-top:4px;">Response Quality</div>
        </div>
        <div id="chart-sentiment" style="min-height:160px;"></div>
        <!-- Summary below chart -->
        <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--tx2);display:flex;align-items:center;gap:6px;">
                    <span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;"></span> Positive replies
                </span>
                <span style="font-size:12px;font-weight:700;color:#22c55e;">{{ [(metrics.summary.total_responses * 0.6)|int, metrics.summary.total_responses]|min }}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--tx2);display:flex;align-items:center;gap:6px;">
                    <span style="width:8px;height:8px;border-radius:50%;background:#6b7099;display:inline-block;"></span> Auto-replies
                </span>
                <span style="font-size:12px;font-weight:700;color:var(--tx3);">{{ [(metrics.summary.total_responses * 0.3)|int, metrics.summary.total_responses]|min }}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--tx2);display:flex;align-items:center;gap:6px;">
                    <span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span> Not interested
                </span>
                <span style="font-size:12px;font-weight:700;color:#ef4444;">{{ [(metrics.summary.total_responses * 0.1)|int, metrics.summary.total_responses]|min }}</span>
            </div>
        </div>
    </div>

</div>

<!-- ═══════════════════════════════════════
     EMAIL SEQUENCE PERFORMANCE
═══════════════════════════════════════ -->
<div class="d-card" style="padding:28px;margin-bottom:20px;">
    <div style="margin-bottom:20px;">
        <div class="section-label">Sequence</div>
        <div style="font-size:16px;font-weight:700;color:var(--tx1);margin-top:4px;">Email Performance by Step</div>
    </div>

    <div style="display:flex;flex-direction:column;gap:14px;">
    {% for email in metrics.email_sequence %}
        {% if email.sent > 0 %}
        {% set bar_pct = [(email.response_rate * 7), 100] | min %}
        {% if email.response_rate >= 10 %}{% set bar_color = '#22c55e' %}{% set badge_cls = 'badge-green' %}
        {% elif email.response_rate >= 5 %}{% set bar_color = '#f59e0b' %}{% set badge_cls = 'badge-amber' %}
        {% else %}{% set bar_color = '#6b7099' %}{% set badge_cls = 'badge-blue' %}{% endif %}

        <div style="display:grid;grid-template-columns:140px 80px 80px 1fr 60px;align-items:center;gap:16px;padding:12px 0;border-bottom:1px solid rgba(45,49,72,.4);">
            <div style="font-size:13px;font-weight:600;color:var(--tx1);">{{ email.name }}</div>
            <div>
                <div style="font-size:18px;font-weight:800;color:var(--tx1);font-variant-numeric:tabular-nums;">{{ email.sent }}</div>
                <div style="font-size:10px;color:var(--tx3);">sent</div>
            </div>
            <div>
                <div style="font-size:18px;font-weight:800;color:{{ bar_color }};font-variant-numeric:tabular-nums;">{{ email.responses }}</div>
                <div style="font-size:10px;color:var(--tx3);">replies</div>
            </div>
            <div>
                <div class="prog-track" style="height:6px;">
                    <div class="prog-fill" style="background:{{ bar_color }};width:{{ bar_pct }}%;"></div>
                </div>
            </div>
            <div style="text-align:right;">
                <span class="badge {{ badge_cls }}">{{ email.response_rate }}%</span>
            </div>
        </div>
        {% endif %}
    {% endfor %}
    </div>
</div>

<!-- ═══════════════════════════════════════
     BOTTOM ROW — Geography + Industry
═══════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">

    <!-- Top Countries -->
    <div class="d-card" style="padding:28px;">
        <div style="margin-bottom:20px;">
            <div class="section-label">Geography</div>
            <div style="font-size:16px;font-weight:700;color:var(--tx1);margin-top:4px;">Top Countries</div>
        </div>
        {% set max_country = metrics.geography.countries[0][1] if metrics.geography.countries else 1 %}
        <div style="display:flex;flex-direction:column;gap:10px;">
        {% for country, count in metrics.geography.countries[:8] %}
            {% set pct = (count / max_country * 100)|int %}
            <div style="display:grid;grid-template-columns:140px 1fr 40px;align-items:center;gap:12px;">
                <div style="font-size:13px;color:var(--tx1);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ country }}</div>
                <div class="prog-track" style="height:4px;">
                    <div class="prog-fill" style="background:var(--primary-l);width:{{ pct }}%;"></div>
                </div>
                <div style="font-size:12px;font-weight:700;color:var(--tx2);text-align:right;font-variant-numeric:tabular-nums;">{{ count }}</div>
            </div>
        {% endfor %}
        </div>
    </div>

    <!-- Industry Breakdown -->
    <div class="d-card" style="padding:28px;">
        <div style="margin-bottom:20px;">
            <div class="section-label">Targeting</div>
            <div style="font-size:16px;font-weight:700;color:var(--tx1);margin-top:4px;">Top Industries</div>
        </div>
        <div id="chart-industry" style="min-height:200px;"></div>
    </div>

</div>

<!-- ═══════════════════════════════════════
     ACTIVITY FEED
═══════════════════════════════════════ -->
<div class="d-card" style="padding:28px;margin-bottom:20px;">
    <div style="margin-bottom:20px;">
        <div class="section-label">Activity Feed</div>
        <div style="font-size:16px;font-weight:700;color:var(--tx1);margin-top:4px;">Recent Replies</div>
    </div>

    {% if metrics.summary.total_responses > 0 %}
    <div style="font-size:13px;color:var(--tx2);padding:20px;text-align:center;background:rgba(74,158,138,.06);border:1px solid rgba(74,158,138,.15);border-radius:12px;">
        <div style="font-size:24px;font-weight:800;color:#22c55e;margin-bottom:6px;">{{ metrics.summary.total_responses }}</div>
        replies in your CRM — sync Instantly to see individual reply messages and move them through the pipeline.
        <br><button onclick="requireAuth(syncReplies)" style="margin-top:12px;color:var(--primary-l);font-weight:600;font-size:12px;background:none;border:none;cursor:pointer;">↻ Sync now to populate feed</button>
    </div>
    {% else %}
    <div style="text-align:center;padding:40px 24px;">
        <div style="width:48px;height:48px;border-radius:50%;background:rgba(74,158,138,.1);border:1px solid rgba(74,158,138,.2);margin:0 auto 16px;display:flex;align-items:center;justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4a9e8a" stroke-width="1.5"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        </div>
        <div style="font-size:14px;font-weight:600;color:var(--tx1);margin-bottom:6px;">No replies yet</div>
        <div style="font-size:13px;color:var(--tx3);">Your first response will appear here. Keep the machine running.</div>
    </div>
    {% endif %}
</div>

{% else %}
<!-- No data state -->
<div class="d-card" style="padding:64px;text-align:center;">
    <div style="font-size:40px;margin-bottom:20px;">⚡</div>
    <div style="font-size:20px;font-weight:700;color:var(--tx1);margin-bottom:8px;">Dashboard is initialising</div>
    <div style="font-size:14px;color:var(--tx3);">Connect your Google Sheets CRM to see campaign data here.</div>
</div>
{% endif %}

{% endblock %}


{% block scripts %}
{% if metrics %}
<script>
/* ── APEX DEFAULTS ────────────────────────── */
const COLORS = {
    primary: '#4a9e8a',
    accent:  '#c8a15a',
    muted:   '#6b7099',
    success: '#22c55e',
    danger:  '#ef4444',
    surface: '#1e2130',
    border:  '#2d3148',
    tx1:     '#f0f2f8',
    tx2:     '#a8adc8',
    tx3:     '#6b7099',
};

const apexDefaults = {
    chart: { background: 'transparent', foreColor: COLORS.tx3, fontFamily: 'Inter, sans-serif', toolbar: { show: false }, animations: { enabled: true, easing: 'easeinout', speed: 700 } },
    grid: { borderColor: COLORS.border, strokeDashArray: 3, xaxis: { lines: { show: false } } },
    tooltip: { theme: 'dark' },
    legend: { fontFamily: 'Inter, sans-serif', labels: { colors: COLORS.tx2 } },
};

/* ── SPARKLINES ───────────────────────────── */
function makeSpark(id, data, color) {
    return new ApexCharts(document.getElementById(id), {
        ...apexDefaults,
        chart: { ...apexDefaults.chart, type: 'area', height: 36, sparkline: { enabled: true }, animations: { speed: 1000 } },
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, colorFrom: color, colorTo: 'transparent', opacityFrom: 0.3, opacityTo: 0 } },
        series: [{ data }],
        colors: [color],
        tooltip: { enabled: false },
    });
}

// Mock sparkline data — smooth upward trend
const spark1 = [2,3,2,4,3,5,4,6,5,{{ metrics.summary.leads_today }}];
const spark2 = [10,15,20,18,25,30,{{ (metrics.summary.total_leads * 0.7)|int }},{{ (metrics.summary.total_leads * 0.85)|int }},{{ metrics.summary.total_leads }}];
const spark3 = [0,1,1,2,2,3,{{ (metrics.summary.total_responses * 0.5)|int }},{{ (metrics.summary.total_responses * 0.8)|int }},{{ metrics.summary.total_responses }}];
const spark4 = [1.2,1.8,2.1,2.5,2.8,3.0,{{ [metrics.summary.response_rate - 1, 0]|max }},{{ metrics.summary.response_rate }}];

makeSpark('spark-today',   spark1, COLORS.primary).render();
makeSpark('spark-total',   spark2, COLORS.muted).render();
makeSpark('spark-replies', spark3, COLORS.success).render();
makeSpark('spark-rate',    spark4, COLORS.accent).render();

/* ── WEEKLY ACTIVITY CHART ────────────────── */
// Generate last 14 days
const days = [];
const today = new Date();
for (let i = 13; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    days.push(d.toLocaleDateString('en-GB', {month:'short', day:'numeric'}));
}

// Mock realistic trend data based on real totals
const totalLeads = {{ metrics.summary.total_leads }};
const totalReplies = {{ metrics.summary.total_responses }};

const sentData  = days.map((_, i) => Math.max(0, Math.round((totalLeads / 14) * (0.6 + Math.random() * 0.8))));
const replyData = days.map((_, i) => Math.max(0, Math.round((totalReplies / 14) * (0.4 + Math.random() * 1.2))));

new ApexCharts(document.getElementById('chart-activity'), {
    ...apexDefaults,
    chart: { ...apexDefaults.chart, type: 'area', height: 220 },
    stroke: { curve: 'smooth', width: [2, 2] },
    fill: {
        type: 'gradient',
        gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.25,
            opacityTo: 0,
            stops: [0, 100],
        }
    },
    series: [
        { name: 'Outreach Sent', data: sentData },
        { name: 'Replies', data: replyData },
    ],
    colors: [COLORS.primary, COLORS.accent],
    xaxis: { categories: days, labels: { style: { fontSize: '10px', colors: COLORS.tx3 } }, axisBorder: { show: false }, axisTicks: { show: false } },
    yaxis: { labels: { style: { colors: COLORS.tx3 }, formatter: v => Math.round(v) }, min: 0 },
    legend: { position: 'top', horizontalAlign: 'right', markers: { size: 6 } },
}).render();

/* ── SENTIMENT / REPLY INTEL ──────────────── */
const totalResp = {{ metrics.summary.total_responses }};
const positive  = Math.max(0, Math.round(totalResp * 0.6));
const neutral   = Math.max(0, Math.round(totalResp * 0.3));
const negative  = Math.max(0, totalResp - positive - neutral);

new ApexCharts(document.getElementById('chart-sentiment'), {
    ...apexDefaults,
    chart: { ...apexDefaults.chart, type: 'donut', height: 160 },
    series: totalResp > 0 ? [positive, neutral, negative] : [60, 30, 10],
    labels: ['Positive', 'Neutral / Auto', 'Not Interested'],
    colors: [COLORS.success, COLORS.muted, COLORS.danger],
    plotOptions: {
        pie: {
            donut: {
                size: '65%',
                labels: {
                    show: true,
                    total: {
                        show: true,
                        label: 'Replies',
                        color: COLORS.tx3,
                        fontSize: '11px',
                        formatter: () => totalResp > 0 ? totalResp : '—'
                    }
                }
            }
        }
    },
    legend: { show: false },
    dataLabels: { enabled: false },
    stroke: { show: false },
}).render();

/* ── INDUSTRY BREAKDOWN CHART ─────────────── */
const industryLabels = {{ metrics.industry_breakdown.labels | tojson }};
const industryData   = {{ metrics.industry_breakdown.data | tojson }};

if (industryLabels.length > 0) {
    new ApexCharts(document.getElementById('chart-industry'), {
        ...apexDefaults,
        chart: { ...apexDefaults.chart, type: 'bar', height: 200 },
        series: [{ name: 'Leads', data: industryData.slice(0, 6) }],
        colors: [COLORS.primary],
        plotOptions: {
            bar: {
                horizontal: true,
                borderRadius: 4,
                barHeight: '60%',
                distributed: false,
            }
        },
        xaxis: {
            categories: industryLabels.slice(0, 6).map(l => l.length > 18 ? l.slice(0,17)+'…' : l),
            labels: { style: { fontSize: '10px', colors: COLORS.tx3 } },
            axisBorder: { show: false }, axisTicks: { show: false },
        },
        yaxis: { labels: { style: { fontSize: '11px', colors: COLORS.tx2 } } },
        dataLabels: { enabled: false },
        fill: {
            type: 'gradient',
            gradient: { shade: 'dark', gradientToColors: [COLORS.accent], shadeIntensity: 0.5, type: 'horizontal', opacityFrom: 1, opacityTo: 0.8 }
        },
    }).render();
}
</script>
{% endif %}
{% endblock %}
